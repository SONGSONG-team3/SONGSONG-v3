<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page with Bootstrap</title>
    <!-- 부트스트랩 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 네비바 스타일 */
        .navbar {
            margin-bottom: 20px;
            background-color: #43486E;
        }
        .navbar-nav .nav-link {
            color: #fff !important;
        }
        .navbar-brand img {
            height: 40px;
        }

        /* 장르 선택 버튼 스타일 */
        .genre-btn {
            background-color: #EDEDED;
            color: black;
            border: none;
            margin: 10px;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 1.2rem;
        }

        .genre-btn.selected {
            background-color: #74C1BA;
            color: white;
        }

        /* 카드 스타일 */
        .card-body {
            background-color: #EDEDED;
            padding: 20px;
            text-align: center;
        }

        .card img {
            border-radius: 50%;
            width: 100px;
            height: 100px;
            object-fit: cover;
        }

        .info-text {
            margin-top: 10px;
            font-size: 1rem;
        }

        /* 카드들을 감싸는 컨테이너 가운데 정렬 */
        .playlist-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 20px;
            margin-top: 20px;
        }

        .card-container {
            width: 18%;
            margin-bottom: 20px;
        }

        .btn-primary:hover {
            background-color: #1E213B;
        }

        .button-container {
            margin-top: 100px;
            max-width: calc(100% - 100px);
            text-align: center;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .playlist.active {
            display: block;
        }
    </style>
</head>
<body>
<!-- 헤더 -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/static">
            <img src="/assets/img/songsong_color.jpg" alt="logo" />
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto" id="user-info"></ul>
        </div>
    </div>
</nav>

<!-- 장르 선택 버튼들 -->
<div class="container button-container text-center">
    <div class="row justify-content-center">
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('1')">발라드</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('2')">힙합</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('3')">인디</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('4')">락/메탈</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('5')">트로트</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('6')">댄스</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('7')">R&B</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('8')">밴드</button>
        </div>
    </div>
</div>

<!-- 플레이리스트 카드 영역 -->
<div class="container playlist-container"></div>

<!-- 페이지네이션 영역 -->
<nav>
    <ul class="pagination"></ul>
</nav>

<!-- 부트스트랩 및 fetch API 사용 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>

    let currentCategory = 0;  // 현재 카테고리 ID 저장
    let totalPages = 0;  // 총 페이지 수 저장

    // 로그인 여부 확인 및 로그인된 유저 정보 가져오기
    document.addEventListener("DOMContentLoaded", async function() {
        try {
            const response = await fetch('/api/user-info');  // 로그인한 유저 정보 가져오기
            if (response.ok) {
                const userDto = await response.json();
                if (userDto) {
                    // 로그인 상태일 때
                    document.getElementById("user-info").innerHTML = `
                        <li class="nav-item">
                            <span class="nav-link">${userDto.userName}님</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/myplaylist">My 플레이리스트</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/">My 페이지</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">로그아웃</a>
                        </li>
                    `;
                }
            } else {
                // 로그인하지 않은 경우
                document.getElementById("user-info").innerHTML = `
                    <li class="nav-item">
                        <a class="nav-link" href="/login">로그인</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/signup">회원가입</a>
                    </li>
                `;
            }
        } catch (error) {
            console.error("로그인 정보 가져오기 오류:", error);
        }
    });

    // 장르 선택 시 플레이리스트 가져오기
    async function showPlaylist(categoryId, page = 0, size = 15) {
        try {
            currentCategory = categoryId;  // 현재 카테고리 설정
            const response = await fetch(`/api/v3/playlists/mainplaylists/${categoryId}?page=${page}&size=${size}`);
            const result = await response.json();
            const playlistContainer = document.querySelector('.playlist-container');
            playlistContainer.innerHTML = '';

            if (result.result === "SUCCESS") {
                result.list.forEach(function(playlistDto) {

                    console.log('playlistDto.userNo:', playlistDto.userNo);
                    console.log('result.userMap:', result.userMap);
                    console.log('result.userCategoryMap:', result.userCategoryMap);

                    const userDto = result.userMap[playlistDto.userNo];
                    if (!userDto) {
                        console.error(`UserDto not found for userNo: ${playlistDto.userNo}`);
                        return;
                    }

                    const songCount = result.songCountMap[playlistDto.userNo];
                    const userCategories = result.userCategoryMap[playlistDto.userNo];
                    const categoriesText = userCategories.map(category => category.categoryName).join(', ');

                    console.log('userDto:', userDto);
                    console.log('userCategories: ', userCategories)
                    console.log('songCount:', songCount);

                    // if(playlistDto.userNo == userNo)
                    //     return;
                    if(songCount == 0)
                        return;

                    const cardHtml = `
                        <div class="card-container">
                            <a href="/playlist/detail/${playlistDto.userNo}">
                                <div class="card">
                                    <div class="card-body">
                                        <img src="${userDto.userImage ? userDto.userImage : '/assets/img/noProfile.png'}" alt="User Image" />
                                        <div class="info-text">😎 ${userDto.userNickname}</div>
                                        <div class="info-text">💿 ${categoriesText}</div>
                                        <div class="info-text">🎵 ${songCount} ❤ ${userDto.userLike}</div>
                                    </div>
                                </div>
                            </a>
                        </div>`;
                    playlistContainer.innerHTML += cardHtml;
                });

                totalPages = result.totalPages; // 총 페이지 수 설정
                console.log("totalPages, page : ", totalPages, page);
                displayPagination(totalPages, page);

            } else {
                playlistContainer.innerHTML = "<p>플레이리스트를 불러올 수 없습니다.</p>";
            }
        } catch (error) {
            console.error("플레이리스트 가져오기 오류:", error);
            document.querySelector('.playlist-container').innerHTML = "<p>플레이리스트를 가져오는 중 오류가 발생했습니다.</p>";
        }
    }

    // 페이지네이션 표시
    function displayPagination(totalPages, currentPage) {
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = '';

        for (let i = 0; i < totalPages; i++) {
            const pageItem = `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="showPlaylist(${currentCategory}, ${i})">${i + 1}</a>
            </li>`;
            pagination.innerHTML += pageItem;
        }
    }
</script>
</body>
</html>

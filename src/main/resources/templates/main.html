<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page with Bootstrap</title>
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ë„¤ë¹„ë°” ìŠ¤íƒ€ì¼ */
        .navbar {
            margin-bottom: 20px;
            background-color: #43486E;
        }
        .navbar-nav .nav-link {
            color: #fff !important;
        }
        .navbar-brand img {
            height: 40px;
        }

        /* ì¥ë¥´ ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .genre-btn {
            background-color: #EDEDED;
            color: black;
            border: none;
            margin: 10px;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 1.2rem;
        }

        .genre-btn.selected {
            background-color: #74C1BA;
            color: white;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card-body {
            background-color: #EDEDED;
            padding: 20px;
            text-align: center;
        }

        .card img {
            border-radius: 50%;
            width: 100px;
            height: 100px;
            object-fit: cover;
        }

        .info-text {
            margin-top: 10px;
            font-size: 1rem;
        }

        /* ì¹´ë“œë“¤ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ê°€ìš´ë° ì •ë ¬ */
        .playlist-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 20px;
            margin-top: 20px;
        }

        .card-container {
            width: 18%;
            margin-bottom: 20px;
        }

        .btn-primary:hover {
            background-color: #1E213B;
        }

        .button-container {
            margin-top: 100px;
            max-width: calc(100% - 100px);
            text-align: center;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .playlist.active {
            display: block;
        }
    </style>
</head>
<body>
<!-- í—¤ë” -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/static">
            <img src="/assets/img/songsong_color.jpg" alt="logo" />
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto" id="user-info"></ul>
        </div>
    </div>
</nav>

<!-- ì¥ë¥´ ì„ íƒ ë²„íŠ¼ë“¤ -->
<div class="container button-container text-center">
    <div class="row justify-content-center">
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('1')">ë°œë¼ë“œ</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('2')">í™í•©</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('3')">ì¸ë””</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('4')">ë½/ë©”íƒˆ</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('5')">íŠ¸ë¡œíŠ¸</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('6')">ëŒ„ìŠ¤</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('7')">R&B</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn genre-btn" onclick="showPlaylist('8')">ë°´ë“œ</button>
        </div>
    </div>
</div>

<!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ì˜ì—­ -->
<div class="container playlist-container"></div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ -->
<nav>
    <ul class="pagination"></ul>
</nav>

<!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© ë° fetch API ì‚¬ìš© -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>

    let currentCategory = 0;  // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ID ì €ì¥
    let totalPages = 0;  // ì´ í˜ì´ì§€ ìˆ˜ ì €ì¥

    // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ ë° ë¡œê·¸ì¸ëœ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener("DOMContentLoaded", async function() {
        try {
            const response = await fetch('/api/user-info');  // ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            if (response.ok) {
                const userDto = await response.json();
                if (userDto) {
                    // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ
                    document.getElementById("user-info").innerHTML = `
                        <li class="nav-item">
                            <span class="nav-link">${userDto.userName}ë‹˜</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/myplaylist">My í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/">My í˜ì´ì§€</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
                        </li>
                    `;
                }
            } else {
                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°
                document.getElementById("user-info").innerHTML = `
                    <li class="nav-item">
                        <a class="nav-link" href="/login">ë¡œê·¸ì¸</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/signup">íšŒì›ê°€ì…</a>
                    </li>
                `;
            }
        } catch (error) {
            console.error("ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
        }
    });

    // ì¥ë¥´ ì„ íƒ ì‹œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    async function showPlaylist(categoryId, page = 0, size = 15) {
        try {
            currentCategory = categoryId;  // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ì„¤ì •
            const response = await fetch(`/api/v3/playlists/mainplaylists/${categoryId}?page=${page}&size=${size}`);
            const result = await response.json();
            const playlistContainer = document.querySelector('.playlist-container');
            playlistContainer.innerHTML = '';

            if (result.result === "SUCCESS") {
                result.list.forEach(function(playlistDto) {

                    console.log('playlistDto.userNo:', playlistDto.userNo);
                    console.log('result.userMap:', result.userMap);
                    console.log('result.userCategoryMap:', result.userCategoryMap);

                    const userDto = result.userMap[playlistDto.userNo];
                    if (!userDto) {
                        console.error(`UserDto not found for userNo: ${playlistDto.userNo}`);
                        return;
                    }

                    const songCount = result.songCountMap[playlistDto.userNo];
                    const userCategories = result.userCategoryMap[playlistDto.userNo];
                    const categoriesText = userCategories.map(category => category.categoryName).join(', ');

                    console.log('userDto:', userDto);
                    console.log('userCategories: ', userCategories)
                    console.log('songCount:', songCount);

                    // if(playlistDto.userNo == userNo)
                    //     return;
                    if(songCount == 0)
                        return;

                    const cardHtml = `
                        <div class="card-container">
                            <a href="/playlist/detail/${playlistDto.userNo}">
                                <div class="card">
                                    <div class="card-body">
                                        <img src="${userDto.userImage ? userDto.userImage : '/assets/img/noProfile.png'}" alt="User Image" />
                                        <div class="info-text">ğŸ˜ ${userDto.userNickname}</div>
                                        <div class="info-text">ğŸ’¿ ${categoriesText}</div>
                                        <div class="info-text">ğŸµ ${songCount} â¤ ${userDto.userLike}</div>
                                    </div>
                                </div>
                            </a>
                        </div>`;
                    playlistContainer.innerHTML += cardHtml;
                });

                totalPages = result.totalPages; // ì´ í˜ì´ì§€ ìˆ˜ ì„¤ì •
                console.log("totalPages, page : ", totalPages, page);
                displayPagination(totalPages, page);

            } else {
                playlistContainer.innerHTML = "<p>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
            }
        } catch (error) {
            console.error("í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
            document.querySelector('.playlist-container').innerHTML = "<p>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
        }
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
    function displayPagination(totalPages, currentPage) {
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = '';

        for (let i = 0; i < totalPages; i++) {
            const pageItem = `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="showPlaylist(${currentCategory}, ${i})">${i + 1}</a>
            </li>`;
            pagination.innerHTML += pageItem;
        }
    }
</script>
</body>
</html>
